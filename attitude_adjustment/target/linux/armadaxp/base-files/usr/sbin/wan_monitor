#!/bin/sh
. /lib/functions.sh
. /lib/functions/network.sh

local scriptname wanhasip wanport
scriptname="$(basename $0)"
wanhasip=0
wanport=/sys/class/neta-switch/port4/carrier
DELAY=2

CNT_CONN=0
DELAY_CONN=16

LINKPING=heartbeat.belkin.com
PING_TIMEOUT=5000 #5s

OUTLOG=/tmp/wan_log

log_message() {
	/usr/bin/logger "$scriptname: $1"
}

blinking_amber() {
	/usr/sbin/ledctrl wan_amber 255 500 500
}

wan_amber() {
	/usr/sbin/ledctrl wan_amber $1
}

blinking_white() {
	/usr/sbin/ledctrl wan_white 255 700 700
}

wan_white() {
	/usr/sbin/ledctrl wan_white $1
}

obtain_wan_ip() {
	local wanif wanipaddr
	while ! network_find_wan wanif
	do
		log_message "Waiting for netifd to register wan interface"
		sleep 2
	done
	while ! network_get_ipaddr wanipaddr "$wanif"
	do
		wan_amber on
		log_message "Obtaining IP address on if: $wanif"
		sleep 2	
	done
	wanhasip=1
}

conn_type_dynamic() {

	#echo "conn_type_dynamic"

	if [ $wanhasip -eq 0 ]; then 
		wan_amber off
		wan_white off
		obtain_wan_ip
	fi

	if [ $wanhasip -eq 1 ]; then
		/bin/ping $LINKPING -c 3 -w ${PING_TIMEOUT} > $OUTLOG
		ping_status=$?
		if [ $ping_status -ne 0 ]
		then
			wan_amber on
			#echo "PING FAILED:" $LINKPING $ping_status
			log_message "PING FAILED"
		else
			wan_white on
			#echo "PING OK:" $LINKPING $ping_status
		fi
	fi
}

#FIXME: would hotplug better serve us here?
echo "WAN LED MONITOR"
while true
do
	x=`cat $wanport`
	#echo "Wan physical status" $x

	#echo $CNT_CONN
	if [ $x = "Up" ]; then
		if [ $wanhasip -eq 0 -o $CNT_CONN -gt $DELAY_CONN ]; then
			conn_type_dynamic
			CNT_CONN=0
		fi
	elif [ $x = "Down" ]; then
		log_message "No physical WAN cable"
		wan_amber off
		wan_white off
		blinking_amber 
		wanhasip=0
		CNT_CONN=0
	fi
	CNT_CONN=$((CNT_CONN+1))
	sleep $DELAY
done

